name: sync-fork-xqqv5

on:
  schedule:
    - cron: '0 0 1 * *' # 每月1号触发
  workflow_dispatch:

jobs:
  sync-forks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ci repository
        uses: actions/checkout@main

      - name: Setup git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Sync all repositories serially
        env:
          GH_TOKEN: ${{ secrets.SYNC_FORK_TOKEN_NO_01_AT_XQQV5 }}
        run: |
          # 定义仓库对数组
          repo_pairs=(
            "linbox-team/fflas-ffpack:xqqv5/fflas-ffpack"
            "komrad36/BitOps:xqqv5/BitOps"
            "komrad36/Factorization-Primality:xqqv5/Factorization-Primality"
            "massgravel/Microsoft-Activation-Scripts:xqqv5/Microsoft-Activation-Scripts"
            "9001/copyparty:xqqv5/copyparty"
            "veeso/termscp:xqqv5/termscp"
            "Keidan/HexViewer:xqqv5/HexViewer"
            "cat3399/blbl:xqqv5/blbl-cat39"
            "flintlib/flint:xqqv5/flint"
            "open-webui/open-webui:xqqv5/open-webui"
            "flutter/flutter:xqqv5/flutter"
            "sumatrapdfreader/sumatrapdf:xqqv5/sumatrapdf"
            "google/skia:xqqv5/skia"
            "microsoft/terminal:xqqv5/terminal"
            "MatrixSeven/file-transfer-go:xqqv5/file-transfer-go"
            "xixu-me/xget:xqqv5/Xget"
            "xixu-me/xget-now:xqqv5/Xget-Now"
            "notepad-plus-plus/notepad-plus-plus:xqqv5/notepad-plus-plus"
            "PowerShell/PowerShell:xqqv5/PowerShell"
            "simdjson/simdjson:xqqv5/simdjson"
            "fastfloat/fast_float:xqqv5/fast_float_int_etc"
            "massivemadness/Squircle-CE:xqqv5/Squircle-CE"
            "ImranR98/Obtainium:xqqv5/Obtainium"
            "sky22333/hubproxy:xqqv5/hubproxy"
            "gildas-lormeau/SingleFile:xqqv5/SingleFile"
            "lyswhut/lx-music-desktop:xqqv5/lx-music-desktop"
            "lyswhut/lx-music-mobile:xqqv5/lx-music-mobile"
            "veracrypt/VeraCrypt:xqqv5/VeraCrypt"
            "Cyan4973/xxHash:xqqv5/xxHash"
            "freedomofpress/dangerzone:xqqv5/dangerzone"
            "WerWolv/ImHex:xqqv5/ImHex"
            "NationalSecurityAgency/ghidra:xqqv5/ghidra"
            "ventoy/Ventoy:xqqv5/Ventoy"
            "WinMerge/winmerge:xqqv5/winmerge"
            "Delphier/DxAutoInstaller:xqqv5/DxAutoInstaller"
            "microsoft/PowerToys:xqqv5/PowerToys"
            "localsend/localsend:xqqv5/localsend"
            "drakkan/sftpgo:xqqv5/sftp-go"
            "tfonteyn/Sshd4a:xqqv5/Sshd4a"
            "amnezia-vpn/amnezia-client:xqqv5/amnezia-client"
            "openssl/openssl:xqqv5/openssl"
            "alireza-md93/GPU-Accelerated-Viterbi-Decoder:xqqv5/GPU-Accelerated-Viterbi-Decoder"
            "malb/m4ri:xqqv5/m4ri"
            "malb/m4rie:xqqv5/m4rie"
            "wolfSSL/wolfssl:xqqv5/wolfssl"
            "alam00000/bentopdf:xqqv5/bentopdf"
            "androidx/media:xqqv5/media"
          )
          for pair in "${repo_pairs[@]}"; do
            SOURCE_REPO="${pair%:*}"
            FORK_REPO="${pair#*:}"
            # 1. 获取源仓库默认分支
            echo "1、获取 $SOURCE_REPO 默认分支..."
            DEFAULT_BRANCH_INFO=$(git ls-remote --symref "https://github.com/${SOURCE_REPO}.git" HEAD)
            DEFAULT_BRANCH=$(echo "$DEFAULT_BRANCH_INFO" | awk '/^ref:/ {sub(/refs\/heads\//, "", $2); print $2; exit}')
            if [ -z "$DEFAULT_BRANCH" ]; then
              DEFAULT_BRANCH=$(echo "$DEFAULT_BRANCH_INFO" | grep -o 'refs/heads/[^ 	]*' | head -1 | sed 's|refs/heads/||')
            fi
            echo "默认分支: $DEFAULT_BRANCH"
            # 2. 克隆 Fork 仓库
            echo "2、克隆镜像仓库..."
            if ! git clone --depth=1 --branch="$DEFAULT_BRANCH" "https://${GH_TOKEN}@github.com/${FORK_REPO}.git" sync-repo; then
              echo "警告：克隆失败，尝试克隆默认分支..."
              rm -rf sync-repo
              git clone --depth=1 "https://${GH_TOKEN}@github.com/${FORK_REPO}.git" sync-repo
              cd sync-repo
              git checkout -b "$DEFAULT_BRANCH" origin/"$DEFAULT_BRANCH" 2>/dev/null || true
            else
              cd sync-repo
            fi
            # 3. 添加上游源仓库并拉取更新
            echo "3、拉取上游更新..."
            git remote add upstream "https://github.com/${SOURCE_REPO}.git" 2>/dev/null || git remote set-url upstream "https://github.com/${SOURCE_REPO}.git"
            git fetch upstream "$DEFAULT_BRANCH"
            # 4. 检查是否有新提交
            echo "4、检查差异..."
            # 比较上游拉取的内容与本地分支
            if git diff --quiet FETCH_HEAD "$DEFAULT_BRANCH"; then
              echo "[$DEFAULT_BRANCH] 已是最新，无需同步。"
            else
              echo "检测到更新，正在同步..."
              # 5. 合并上游更新并推送
              if git merge --ff-only FETCH_HEAD; then
                git push origin "$DEFAULT_BRANCH"
                echo "[$DEFAULT_BRANCH] 同步完成。"
              else
                echo "警告：快速合并失败，可能是分支历史有分歧。"
                echo "尝试重置并强制推送..."
                git reset --hard FETCH_HEAD
                git push --force origin "$DEFAULT_BRANCH"
                echo "[$DEFAULT_BRANCH] 已强制同步。"
              fi
            fi
            # 6. 清理并返回上级目录
            echo "5、清理..."
            cd ..
            rm -rf sync-repo
            echo -e "$SOURCE_REPO 同步完成\n"
            sleep 1
          done